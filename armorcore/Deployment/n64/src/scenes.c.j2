#include <libdragon.h>
#include <t3d/t3d.h>
#include <t3d/t3dmodel.h>

#include "types.h"
#include "scenes.h"

static ArmScene g_scenes[SCENE_COUNT];
static SceneId g_pending_scene = SCENE_COUNT;  // SCENE_COUNT = no pending

void scene_init(SceneId id)
{{
    if (id >= SCENE_COUNT) {{
        return;
    }}

    switch (id) {{
{scene_init_switch_cases}
		default:
			break;
    }}

	scene_on_ready(id);
}}

void scene_on_ready(SceneId id)
{{
	ArmScene *s = &g_scenes[id];

	// Scene-level traits
	for (uint8_t i = 0; i < s->trait_count; i++) {{
		if (s->traits[i].on_ready) {{
			s->traits[i].on_ready(s, s->traits[i].data);
		}}
	}}

	// Camera traits
	if (s->cameras) {{
		for (uint8_t i = 0; i < s->camera_count; i++) {{
			for (uint8_t t = 0; t < s->cameras[i].trait_count; t++) {{
				if (s->cameras[i].traits[t].on_ready) {{
					s->cameras[i].traits[t].on_ready(&s->cameras[i], s->cameras[i].traits[t].data);
				}}
			}}
		}}
	}}

	// Light traits
	if (s->lights) {{
		for (uint8_t i = 0; i < s->light_count; i++) {{
			for (uint8_t t = 0; t < s->lights[i].trait_count; t++) {{
				if (s->lights[i].traits[t].on_ready) {{
					s->lights[i].traits[t].on_ready(&s->lights[i], s->lights[i].traits[t].data);
				}}
			}}
		}}
	}}

	// Object traits
	if (s->objects) {{
		for (uint16_t i = 0; i < s->object_count; i++) {{
			for (uint8_t t = 0; t < s->objects[i].trait_count; t++) {{
				if (s->objects[i].traits[t].on_ready) {{
					s->objects[i].traits[t].on_ready(&s->objects[i], s->objects[i].traits[t].data);
				}}
			}}
		}}
	}}
}}

void scene_on_update(SceneId id, float dt)
{{
	ArmScene *s = &g_scenes[id];

	// Scene-level traits
	for (uint8_t i = 0; i < s->trait_count; i++) {{
		if (s->traits[i].on_update) {{
			s->traits[i].on_update(s, dt, s->traits[i].data);
		}}
	}}

	// Camera traits
	if (s->cameras) {{
		for (uint8_t i = 0; i < s->camera_count; i++) {{
			for (uint8_t t = 0; t < s->cameras[i].trait_count; t++) {{
				if (s->cameras[i].traits[t].on_update) {{
					s->cameras[i].traits[t].on_update(&s->cameras[i], dt, s->cameras[i].traits[t].data);
				}}
			}}
		}}
	}}

	// Light traits
	if (s->lights) {{
		for (uint8_t i = 0; i < s->light_count; i++) {{
			for (uint8_t t = 0; t < s->lights[i].trait_count; t++) {{
				if (s->lights[i].traits[t].on_update) {{
					s->lights[i].traits[t].on_update(&s->lights[i], dt, s->lights[i].traits[t].data);
				}}
			}}
		}}
	}}

	// Object traits
	if (s->objects) {{
		for (uint16_t i = 0; i < s->object_count; i++) {{
			for (uint8_t t = 0; t < s->objects[i].trait_count; t++) {{
				if (s->objects[i].traits[t].on_update) {{
					s->objects[i].traits[t].on_update(&s->objects[i], dt, s->objects[i].traits[t].data);
				}}
			}}
		}}
	}}
}}

void scene_on_remove(SceneId id)
{{
	ArmScene *s = &g_scenes[id];

	// Scene-level traits
	for (uint8_t i = 0; i < s->trait_count; i++) {{
		if (s->traits[i].on_remove) {{
			s->traits[i].on_remove(s, s->traits[i].data);
		}}
	}}

	// Camera traits
	if (s->cameras) {{
		for (uint8_t i = 0; i < s->camera_count; i++) {{
			for (uint8_t t = 0; t < s->cameras[i].trait_count; t++) {{
				if (s->cameras[i].traits[t].on_remove) {{
					s->cameras[i].traits[t].on_remove(&s->cameras[i], s->cameras[i].traits[t].data);
				}}
			}}
		}}
	}}

	// Light traits
	if (s->lights) {{
		for (uint8_t i = 0; i < s->light_count; i++) {{
			for (uint8_t t = 0; t < s->lights[i].trait_count; t++) {{
				if (s->lights[i].traits[t].on_remove) {{
					s->lights[i].traits[t].on_remove(&s->lights[i], s->lights[i].traits[t].data);
				}}
			}}
		}}
	}}

	// Object traits
	if (s->objects) {{
		for (uint16_t i = 0; i < s->object_count; i++) {{
			for (uint8_t t = 0; t < s->objects[i].trait_count; t++) {{
				if (s->objects[i].traits[t].on_remove) {{
					s->objects[i].traits[t].on_remove(&s->objects[i], s->objects[i].traits[t].data);
				}}
			}}
		}}
	}}
}}

void scene_clear(SceneId id)
{{
    if (id >= SCENE_COUNT) {{
        return;
    }}

    ArmScene *s = &g_scenes[id];

    if (s->objects != NULL) {{
        scene_on_remove(id);

		for (uint16_t i = 0; i < s->object_count; i++) {{
			if (s->objects[i].model_mat) {{
				free_uncached(s->objects[i].model_mat);
				s->objects[i].model_mat = NULL;
			}}
			s->objects[i].dpl = NULL;
		}}
	}}

	s->world.clear_color[0] = s->world.clear_color[1] = s->world.clear_color[2] = 0;
	s->world.clear_color[3] = 0xFF;
	s->world.ambient_color[0] = s->world.ambient_color[1] = s->world.ambient_color[2] = 0;
	s->world.ambient_color[3] = 0xFF;

	s->cameras = NULL;
	s->camera_count = 0;
	s->active_camera_id = 0;

	s->lights = NULL;
	s->light_count = 0;
	s->objects = NULL;
	s->object_count = 0;
}}

ArmScene *scene_get(SceneId id)
{{
    if (id >= SCENE_COUNT) {{
        return NULL;
    }}
    return &g_scenes[id];
}}

SceneId scene_get_pending(void)
{{
    return g_pending_scene;
}}

void scene_switch_to(SceneId id)
{{
    g_pending_scene = id;
}}

void scene_clear_pending(void)
{{
    g_pending_scene = SCENE_COUNT;
}}
