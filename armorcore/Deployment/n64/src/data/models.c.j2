#include <libdragon.h>
#include <t3d/t3d.h>
#include <t3d/t3dmodel.h>

#include "models.h"

static const char *MODEL_PATHS[MODEL_COUNT] = {{
{mesh_paths}
}};

typedef struct {{
    T3DModel *model;
    rspq_block_t *dpl;
    uint8_t loaded;
}} ModelEntry;

static ModelEntry g_models[MODEL_COUNT];

void models_init(void)
{{
    for (uint8_t i = 0; i < MODEL_COUNT; i++) {{
        g_models[i].model = NULL;
		g_models[i].dpl = NULL;
        g_models[i].loaded = 0;
    }}
}}

void models_shutdown(void)
{{
    for (uint8_t i = 0; i < MODEL_COUNT; i++) {{
        if (g_models[i].loaded) {{
            if (g_models[i].model) {{
                t3d_model_free(g_models[i].model);
                g_models[i].model = NULL;
            }}
            if (g_models[i].dpl) {{
                rspq_block_free(g_models[i].dpl);
                g_models[i].dpl = NULL;
            }}
            g_models[i].loaded = 0;
        }}
    }}
}}

T3DModel *models_get(ModelId id)
{{
    if (id < 0 || id >= MODEL_COUNT) {{
        return NULL;
    }}

    ModelEntry *e = &g_models[id];
    if (!e->loaded) {{
        const char *path = MODEL_PATHS[id];
        e->model = t3d_model_load(path);
		rspq_block_begin();
		t3d_model_draw(e->model);
		e->dpl = rspq_block_end();
		e->loaded = 1;
    }}
    return e->model;
}}

rspq_block_t *models_get_dpl(ModelId id)
{{
    return g_models[id].dpl;
}}

// TODO: Implement reference counting to track which scenes use which models.
//       Currently models are cached forever. To properly unload:
//       1. Track model usage per scene (e.g., ref count or bitmask)
//       2. Only free when no scene references the model
//       3. Call this from scene_clear() for models only used by that scene
void models_unload(ModelId id)
{{
    if (id < 0 || id >= MODEL_COUNT) {{
        return;
    }}

    ModelEntry *e = &g_models[id];
    if (e->loaded) {{
        if (e->model) {{
            t3d_model_free(e->model);
            e->model = NULL;
        }}
        if (e->dpl) {{
            rspq_block_free(e->dpl);
            e->dpl = NULL;
        }}
        e->loaded = 0;
    }}
}}
