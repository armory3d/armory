#pragma once

#include <stdbool.h>
#include <stdint.h>
#include <rspq.h>
#include <t3d/t3dmath.h>
#include <t3d/t3dmodel.h>

#ifdef __cplusplus
extern "C" {{
#endif

#define FB_COUNT 3 {debug_hud_define}

// Number of frames to keep transform dirty for double/triple buffering
#define TRANSFORM_DIRTY_FRAMES 3

struct OimoRigidBody;

typedef struct {{ float x, y; }} ArmVec2;
typedef struct {{ float x, y, z; }} ArmVec3;
typedef struct {{ float x, y, z, w; }} ArmVec4;

typedef void (*ArmTraitReadyFn)(void *entity, void *data);
typedef void (*ArmTraitFixedUpdateFn)(void *entity, float dt, void *data);
typedef void (*ArmTraitUpdateFn)(void *entity, float dt, void *data);
typedef void (*ArmTraitLateUpdateFn)(void *entity, float dt, void *data);
typedef void (*ArmTraitRemoveFn)(void *entity, void *data);

typedef struct {{
    ArmTraitReadyFn on_ready;
    ArmTraitFixedUpdateFn on_fixed_update;
    ArmTraitUpdateFn on_update;
    ArmTraitLateUpdateFn on_late_update;
    ArmTraitRemoveFn on_remove;
    void *data;
}} ArmTrait;

typedef struct {{
    float loc[3];
    float rot[4];   // quaternion XYZW
    float scale[3];
    uint8_t dirty;
}} ArmTransform;

typedef struct ArmObject {{
    ArmTransform transform;
    rspq_block_t *dpl;
    T3DMat4FP *model_mat;
    bool visible;
    T3DVec3 bounds_center;
    float bounds_radius;
    struct OimoRigidBody *rigid_body;
    uint8_t trait_count;
    ArmTrait *traits;
}} ArmObject;

typedef struct ArmLight {{
    ArmTransform transform;
    uint8_t color[4];
    T3DVec3 dir;
    uint8_t trait_count;
    ArmTrait *traits;
}} ArmLight;

typedef struct ArmCamera {{
    ArmTransform transform;
    T3DVec3 target;
    float fov;
    float near;
    float far;
    uint8_t trait_count;
    ArmTrait *traits;
}} ArmCamera;

typedef struct {{
    uint8_t clear_color[4];
    uint8_t ambient_color[4];
}} ArmWorld;

typedef struct ArmScene {{
    ArmWorld world;

    uint8_t camera_count;
    ArmCamera *cameras;
    uint8_t active_camera_id;

    uint8_t light_count;
    ArmLight *lights;

    uint16_t object_count;
    ArmObject *objects;

    uint8_t trait_count;
    ArmTrait *traits;
}} ArmScene;

#ifdef __cplusplus
}}
#endif
