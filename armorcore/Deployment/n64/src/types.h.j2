#pragma once

#include <stdbool.h>
#include <stdint.h>
#include <rspq.h>
#include <t3d/t3dmath.h>
#include <t3d/t3dmodel.h>

#ifdef __cplusplus
extern "C" {{
#endif

#define FB_COUNT 3

typedef void (*ArmTraitReadyFn)(void *entity, void *data);
typedef void (*ArmTraitUpdateFn)(void *entity, float dt, void *data);
typedef void (*ArmTraitRemoveFn)(void *entity, void *data);

typedef struct {{
    ArmTraitReadyFn on_ready;
    ArmTraitUpdateFn on_update;
    ArmTraitRemoveFn on_remove;
    void *data;
}} ArmTrait;

// Unified transform - matches Iron's Transform class
typedef struct {{
    float loc[3];   // Location/position
    float rot[3];   // Rotation (euler angles in radians)
    float scale[3]; // Scale
    uint8_t dirty;  // Counts down frames needing matrix update (for triple buffering)
}} ArmTransform;

typedef struct ArmObject {{
    ArmTransform transform;

    rspq_block_t *dpl;
    T3DMat4FP *model_mat;

    bool visible;

    uint8_t trait_count;
    ArmTrait *traits;
}} ArmObject;

typedef struct ArmLight {{
    ArmTransform transform;

    uint8_t color[4];
    T3DVec3 dir;  // Computed from transform.rot

    uint8_t trait_count;
    ArmTrait *traits;
}} ArmLight;

typedef struct ArmCamera {{
    ArmTransform transform;

    T3DVec3 target;  // Look-at target (can be computed from transform)
    float fov;
    float near;
    float far;

    uint8_t trait_count;
    ArmTrait *traits;
}} ArmCamera;

typedef struct {{
    uint8_t clear_color[4];
    uint8_t ambient_color[4];
}} ArmWorld;

typedef struct ArmScene {{
    ArmWorld world;

    uint8_t camera_count;
    ArmCamera *cameras;
    uint8_t active_camera_id;

    uint8_t light_count;
    ArmLight *lights;

    uint16_t object_count;
    ArmObject *objects;

    uint8_t trait_count;
    ArmTrait *traits;
}} ArmScene;

#ifdef __cplusplus
}}
#endif
