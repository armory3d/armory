#include <libdragon.h>
#include <t3d/t3d.h>
#include <t3d/t3dmodel.h>

#include "../types.h"
#include "../engine.h"
#include "../renderer.h"
#include "../data/models.h"
#include "../data/traits.h"
#include "../data/scenes.h"

#if ENGINE_ENABLE_PHYSICS
#include "../oimo/physics.h"
#include "../events/physics_events.h"
#if ENGINE_ENABLE_PHYSICS_DEBUG
#include "../oimo/debug/physics_debug.h"
#endif
#endif

extern rspq_block_t *models_get_dpl(ModelId id);

void scene_{scene_name}_init(ArmScene *scene)
{{
    scene->world.clear_color[0] = {cr};
    scene->world.clear_color[1] = {cg};
    scene->world.clear_color[2] = {cb};
    scene->world.clear_color[3] = 0xFF;

    scene->world.ambient_color[0] = {ar};
    scene->world.ambient_color[1] = {ag};
    scene->world.ambient_color[2] = {ab};
    scene->world.ambient_color[3] = 0xFF;

    static ArmCamera cameras[{camera_count}];
    scene->cameras = cameras;
    scene->camera_count = {camera_count};
    scene->active_camera_id = 0;

{cameras_block}

    // Compute lifecycle flags for cameras from traits
    for (uint8_t i = 0; i < scene->camera_count; i++) {{
        if (scene->cameras[i].trait_count > 0) {{
            scene->cameras[i].lifecycle_flags = 0;
            for (uint8_t t = 0; t < scene->cameras[i].trait_count; t++) {{
                if (scene->cameras[i].traits[t].on_fixed_update) scene->cameras[i].lifecycle_flags |= ARM_LIFECYCLE_FIXED_UPDATE;
                if (scene->cameras[i].traits[t].on_update) scene->cameras[i].lifecycle_flags |= ARM_LIFECYCLE_UPDATE;
                if (scene->cameras[i].traits[t].on_late_update) scene->cameras[i].lifecycle_flags |= ARM_LIFECYCLE_LATE_UPDATE;
            }}
        }}
    }}

    static ArmLight lights[{light_count}];
    scene->lights = lights;
    scene->light_count = {light_count};

{lights_block}

    // Compute lifecycle flags for lights from traits
    for (uint8_t i = 0; i < scene->light_count; i++) {{
        if (scene->lights[i].trait_count > 0) {{
            scene->lights[i].lifecycle_flags = 0;
            for (uint8_t t = 0; t < scene->lights[i].trait_count; t++) {{
                if (scene->lights[i].traits[t].on_fixed_update) scene->lights[i].lifecycle_flags |= ARM_LIFECYCLE_FIXED_UPDATE;
                if (scene->lights[i].traits[t].on_update) scene->lights[i].lifecycle_flags |= ARM_LIFECYCLE_UPDATE;
                if (scene->lights[i].traits[t].on_late_update) scene->lights[i].lifecycle_flags |= ARM_LIFECYCLE_LATE_UPDATE;
            }}
        }}
    }}

    static ArmObject objects[{object_count}];
    scene->objects = objects;
    scene->object_count = {object_count};
    scene->active_count = {object_count};  // All objects start active

    // Initialize object pool free list (for runtime recycling)
    static uint16_t free_list[{object_count}];
    scene->free_list = free_list;
    scene->free_count = 0;  // No free slots initially
    scene->free_capacity = {object_count};

    // Initialize active objects list (objects with traits that need updates)
    static uint16_t active_objects[{object_count}];
    scene->active_objects = active_objects;
    scene->active_trait_count = 0;

{objects_block}

    // Build active objects list and lifecycle flags after objects are initialized
    for (uint16_t i = 0; i < scene->object_count; i++) {{
        ArmObject *obj = &scene->objects[i];
        if (obj->trait_count > 0 && !obj->is_removed) {{
            // Compute lifecycle flags from traits
            obj->lifecycle_flags = 0;
            for (uint8_t t = 0; t < obj->trait_count; t++) {{
                if (obj->traits[t].on_fixed_update) obj->lifecycle_flags |= ARM_LIFECYCLE_FIXED_UPDATE;
                if (obj->traits[t].on_update) obj->lifecycle_flags |= ARM_LIFECYCLE_UPDATE;
                if (obj->traits[t].on_late_update) obj->lifecycle_flags |= ARM_LIFECYCLE_LATE_UPDATE;
            }}
            // Add to active list if has any update callbacks
            if (obj->lifecycle_flags != 0) {{
                scene->active_objects[scene->active_trait_count++] = i;
            }}
        }}
    }}

#if ENGINE_ENABLE_PHYSICS
{physics_block}
{contact_subs_block}
#endif

    scene->trait_count = {scene_trait_count};
    scene->lifecycle_flags = 0;
{scene_traits_block}
}}
