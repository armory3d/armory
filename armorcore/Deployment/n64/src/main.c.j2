#include <libdragon.h>
#include <t3d/t3d.h>
#include <t3d/t3dmath.h>

#include "types.h"
#include "engine.h"
#include "renderer.h"
#include "scenes.h"

static float get_time_s(void)
{{
    return (float)((double)get_ticks_ms() / 1000.0);
}}

int main(void)
{{
    engine_init();
    scenes_init_all(); // May not be needed

    T3DViewport viewport = t3d_viewport_create_buffered(FB_COUNT);

    SceneId current_scene = {initial_scene_id};
	scene_init(current_scene);
	scene_on_ready(current_scene);

	float last = get_time_s();
    const float SWITCH_INTERVAL = 5.0f;

    while (1) {{
		float now = get_time_s();
		float dt = now - last;

        if ((now - last) >= SWITCH_INTERVAL) {{
            current_scene = (SceneId)(((int)current_scene + 1) % SCENE_COUNT);
			last = now;
        }}

		scene_on_update(current_scene, dt);

        ArmScene *scene = scene_get(current_scene);

        renderer_begin_frame(&viewport, scene);
        renderer_update_objects(scene);
        renderer_draw_scene(&viewport, scene);
    }}

    engine_shutdown();
    return 0;
}}
