#include <libdragon.h>
#include <t3d/t3d.h>
#include <t3d/t3dmath.h>

#include "types.h"
#include "engine.h"
#include "renderer.h"
#include "scenes.h"

static float get_time_s(void)
{{
    return (float)((double)get_ticks_ms() / 1000.0);
}}

int main(void)
{{
    engine_init();

    T3DViewport viewport = t3d_viewport_create_buffered(FB_COUNT);

    SceneId current_scene = {initial_scene_id};
	scene_init(current_scene);
	scene_on_ready(current_scene);

	float last_switch_time = get_time_s();
    const float SWITCH_INTERVAL = 5.0f;

    while (1) {{
		float now = get_time_s();
        if ((now - last_switch_time) >= SWITCH_INTERVAL) {{
			SceneId next_scene = (SceneId)(((int)current_scene + 1) % SCENE_COUNT);
			scene_on_remove(current_scene);
			scene_init(next_scene);
			scene_on_ready(next_scene);
			current_scene = next_scene;
			last_switch_time = now;
        }}

        ArmScene *scene = scene_get(current_scene);

        renderer_begin_frame(&viewport, scene);
        renderer_draw_scene(&viewport, scene);
    }}

    engine_shutdown();
    return 0;
}}
