#include <libdragon.h>
#include <t3d/t3d.h>
#include <t3d/t3dmath.h>

#include "types.h"
#include "engine.h"
#include "renderer.h"
#include "scenes.h"
#include "input.h"

static float get_time_s(void)
{{
    return (float)((double)get_ticks_ms() / 1000.0);
}}

int main(void)
{{
    engine_init();

    T3DViewport viewport = t3d_viewport_create_buffered(FB_COUNT);

    SceneId current_scene = {initial_scene_id};
	scene_init(current_scene);

	float last_time = get_time_s();

    for (;;) {{
        float now = get_time_s();
        float dt = now - last_time;
        last_time = now;

        input_poll();

        ArmScene *scene = scene_get(current_scene);
        scene_on_update(current_scene, dt);

        // Handle deferred scene switch
        SceneId pending = scene_get_pending();
        if (pending < SCENE_COUNT) {{
            scene_clear_pending();
            scene_clear(current_scene);
            current_scene = pending;
            scene_init(current_scene);
            scene = scene_get(current_scene);
        }}

        renderer_begin_frame(&viewport, scene);
        renderer_draw_scene(&viewport, scene);
    }}

    engine_shutdown();
    return 0;
}}
