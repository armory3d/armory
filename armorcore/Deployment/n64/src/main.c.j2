#include <libdragon.h>
#include <t3d/t3d.h>
#include <t3d/t3dmath.h>

#include "types.h"
#include "engine.h"
#include "renderer.h"
#include "data/scenes.h"
#include "data/models.h"
#include "iron/system/input.h"
#include "iron/trait_events.h"
#if ENGINE_ENABLE_PHYSICS
#include "physics.h"
#endif

#define FIXED_TIMESTEP ({fixed_timestep}f)

static float get_time_s(void)
{{
    return (float)((double)get_ticks_ms() / 1000.0);
}}

int main(void)
{{
    engine_init();
    trait_events_init();

    T3DViewport viewport = t3d_viewport_create_buffered(FB_COUNT);

    SceneId current_scene = {initial_scene_id};
    scene_init(current_scene);

    float last_time = get_time_s();
    float fixed_time = 0.0f;

    for (;;) {{
        float now = get_time_s();
        float dt = now - last_time;
        last_time = now;

        input_poll();
        trait_events_dispatch(dt);

        ArmScene *scene = scene_get(current_scene);

        fixed_time += dt;
        while (fixed_time >= FIXED_TIMESTEP) {{
#if ENGINE_ENABLE_PHYSICS
            physics_step(FIXED_TIMESTEP);
            scene_sync_physics(current_scene);
#endif
            scene_on_fixed_update(current_scene, FIXED_TIMESTEP);
            fixed_time -= FIXED_TIMESTEP;
        }}

        scene_on_update(current_scene, dt);
        scene_on_late_update(current_scene, dt);

        SceneId pending = scene_get_pending();
        if (pending < SCENE_COUNT) {{
            scene_clear_pending();
            scene_clear(current_scene);
            trait_events_clear();
#if ENGINE_ENABLE_PHYSICS
            physics_reset();
#endif
            // Free all models to reclaim memory before loading new scene
            models_unload_all();
            fixed_time = 0.0f;
            current_scene = pending;
            scene_init(current_scene);
            scene = scene_get(current_scene);
        }}

        renderer_begin_frame(&viewport, scene);
        renderer_draw_scene(&viewport, scene);
    }}

    engine_shutdown();
    return 0;
}}
