#pragma once

#include <stdint.h>
#include <stdbool.h>
#include "../data/scenes.h"

#ifdef __cplusplus
extern "C" {{
#endif

// Label key defines (generated from Koui Editor canvas JSON)
{label_defines}

#define UI_LABEL_COUNT {label_count}

// Image key defines (generated from Koui Editor canvas JSON)
{image_defines}

#define UI_IMAGE_COUNT {image_count}

// Group key defines (for Koui containers - enables parent-child visibility)
{group_defines}

#define UI_GROUP_COUNT {group_count}

// Total "element" count for Haxe elements[] array compatibility
// This includes top-level images and groups (not nested images/labels)
#define UI_ELEMENT_COUNT {element_count}

#if UI_LABEL_COUNT > 0 || UI_IMAGE_COUNT > 0 || UI_GROUP_COUNT > 0

// Max UI elements
#ifndef UI_MAX_LABELS
#define UI_MAX_LABELS 32
#endif

#ifndef UI_MAX_IMAGES
#define UI_MAX_IMAGES 16
#endif

#ifndef UI_MAX_GROUPS
#define UI_MAX_GROUPS 8
#endif

#ifndef UI_MAX_GROUP_CHILDREN
#define UI_MAX_GROUP_CHILDREN 8
#endif

// Max text length for labels
#ifndef UI_LABEL_TEXT_SIZE
#define UI_LABEL_TEXT_SIZE 64
#endif

// Canvas dimensions
#define CANVAS_WIDTH {canvas_width}
#define CANVAS_HEIGHT {canvas_height}

// Anchor enum (matches Koui Editor)
typedef enum {{
    UI_ANCHOR_TOP_LEFT = 0,
    UI_ANCHOR_TOP_CENTER = 1,
    UI_ANCHOR_TOP_RIGHT = 2,
    UI_ANCHOR_MIDDLE_LEFT = 3,
    UI_ANCHOR_MIDDLE_CENTER = 4,
    UI_ANCHOR_MIDDLE_RIGHT = 5,
    UI_ANCHOR_BOTTOM_LEFT = 6,
    UI_ANCHOR_BOTTOM_CENTER = 7,
    UI_ANCHOR_BOTTOM_RIGHT = 8,
}} UIAnchor;

// Label element
typedef struct {{
    int16_t pos_x, pos_y;
    int16_t baseline_offset;                // Vertical offset for text baseline (font-dependent)
    char text[UI_LABEL_TEXT_SIZE];          // Owned buffer, not pointer
    uint8_t font_id;
    uint8_t style_id;                       // Font style ID for text color (from Koui theme)
    bool visible;
}} UILabel;

// Forward declaration for sprite_t
struct sprite_s;
typedef struct sprite_s sprite_t;

// Image element
typedef struct {{
    int16_t pos_x, pos_y;
    int16_t width, height;                  // Display dimensions (may differ from sprite if scaled)
    sprite_t *sprite;                       // Loaded sprite (NULL until canvas_init)
    bool scale;                             // Whether to scale sprite to width/height
    bool visible;
}} UIImage;

// Group element (container for multiple images/labels with shared visibility)
// This maps to Koui containers - setting group.visible affects all children
typedef struct {{
    uint8_t child_image_indices[UI_MAX_GROUP_CHILDREN];   // Indices into image array
    uint8_t child_label_indices[UI_MAX_GROUP_CHILDREN];   // Indices into label array
    uint8_t num_child_images;
    uint8_t num_child_labels;
    bool visible;
}} UIGroup;

// Element type enum for the unified elements[] array
typedef enum {{
    UI_ELEM_IMAGE = 0,      // Direct image (no parent group)
    UI_ELEM_GROUP = 1,      // Group/container
}} UIElementType;

// Unified element reference (for Haxe elements[] array compatibility)
typedef struct {{
    UIElementType type;
    uint8_t index;          // Index into images[] or groups[] depending on type
}} UIElement;

// Initialize canvas system (call once at startup)
void canvas_init(void);

// Initialize canvas for a specific scene (clears and reloads labels/images)
void canvas_scene_init(SceneId scene_id);

// Clear all labels/images and reset pool (call on scene change)
void canvas_clear(void);

// Label management
UILabel* ui_label_create(const char *text);           // Create label (not added to scene)
void ui_label_add(UILabel *label);                    // Add label to render list
void ui_label_remove(UILabel *label);                 // Remove label from render list
void ui_label_set_position(UILabel *label, int16_t x, int16_t y);
void ui_label_set_text(UILabel *label, const char *text);  // Set label text (copies string)

// Image management
UIImage* ui_image_create(sprite_t *sprite);           // Create image (not added to scene)
void ui_image_add(UIImage *image);                    // Add image to render list
void ui_image_remove(UIImage *image);                 // Remove image from render list
void ui_image_set_position(UIImage *image, int16_t x, int16_t y);
void ui_image_set_size(UIImage *image, int16_t width, int16_t height);

// Get label by index (for canvas-defined labels)
UILabel* canvas_get_label(int index);

// Get image by index (for canvas-defined images)
UIImage* canvas_get_image(int index);

// Get group by index (for container elements)
UIGroup* canvas_get_group(int index);

// Set group visibility and propagate to children (for trait code)
void ui_group_set_visible(UIGroup *group, bool visible);

// Get element by index (unified access for Haxe elements[] array)
// Returns pointer to UIElement which describes the element type and index
UIElement* canvas_get_element(int index);

// Set element visibility (handles both direct images and groups with children)
void canvas_element_set_visible(int index, bool visible);

// Render all UI elements (call after 3D rendering, before display_show)
void canvas_render(void);

#else
// Stubs when no UI labels or images exist
static inline void canvas_init(void) {{}}
static inline void canvas_scene_init(SceneId scene_id) {{ (void)scene_id; }}
static inline void canvas_clear(void) {{}}
static inline void canvas_render(void) {{}}
static inline void canvas_element_set_visible(int index, bool visible) {{ (void)index; (void)visible; }}

#endif // UI_LABEL_COUNT > 0 || UI_IMAGE_COUNT > 0 || UI_GROUP_COUNT > 0

#ifdef __cplusplus
}}
#endif
