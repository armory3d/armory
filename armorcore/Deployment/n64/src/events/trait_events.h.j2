#pragma once

#include "../types.h"
#include "../iron/system/input.h"

#ifdef __cplusplus
extern "C" {{
#endif

/**
 * Event-driven trait system.
 *
 * Instead of checking input inside on_update, traits register handlers
 * for specific button events. The engine polls input once and dispatches
 * to all registered handlers.
 *
 * Event types:
 *   - btn_<button>_started  - Button just pressed this frame
 *   - btn_<button>_released - Button just released this frame
 *   - btn_<button>_down     - Button held down
 *
 * Performance: Uses bitmask to skip buttons with no subscribers.
 */

// Maximum traits that can subscribe to a single button event
#define MAX_BUTTON_SUBSCRIBERS {max_button_subscribers}

// Event handler function signature: (obj, data, dt)
typedef void (*TraitEventHandler)(void* obj, void* data, float dt);

// Subscription entry: links a handler to an object/data pair
typedef struct {{
    TraitEventHandler handler;
    void* obj;
    void* data;
}} TraitEventSub;

// Per-button event subscriptions
typedef struct {{
    TraitEventSub started[MAX_BUTTON_SUBSCRIBERS];
    TraitEventSub released[MAX_BUTTON_SUBSCRIBERS];
    TraitEventSub down[MAX_BUTTON_SUBSCRIBERS];
    uint8_t started_count;
    uint8_t released_count;
    uint8_t down_count;
}} ButtonEventSubs;

// Global event state
typedef struct {{
    ButtonEventSubs buttons[N64_BTN_COUNT];
    uint16_t has_started_subs;   // Bitmask: which buttons have started subscribers
    uint16_t has_released_subs;  // Bitmask: which buttons have released subscribers
    uint16_t has_down_subs;      // Bitmask: which buttons have down subscribers
}} TraitEventState;

// Initialize event system (call once at startup)
void trait_events_init(void);

// Clear all subscriptions (call on scene change)
void trait_events_clear(void);

// Subscribe to button events
void trait_events_subscribe_started(N64Button btn, TraitEventHandler handler, void* obj, void* data);
void trait_events_subscribe_released(N64Button btn, TraitEventHandler handler, void* obj, void* data);
void trait_events_subscribe_down(N64Button btn, TraitEventHandler handler, void* obj, void* data);

// Unsubscribe from button events (by object pointer)
void trait_events_unsubscribe_started(N64Button btn, void* obj);
void trait_events_unsubscribe_released(N64Button btn, void* obj);
void trait_events_unsubscribe_down(N64Button btn, void* obj);
void trait_events_unsubscribe_all(void* obj);  // Remove all subscriptions for an object

// Dispatch all button events (call once per frame after input_poll)
void trait_events_dispatch(float dt);

#ifdef __cplusplus
}}
#endif
